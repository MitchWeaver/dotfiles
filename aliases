#!/bin/loksh
#
# http://github.com/mitchweaver/dots
#
# # # # # # # # # # # # # # # # # # #

# dynamic 'c' utility
c() {
    if [ -z "$1" ] ; then
        clear
    elif [ -d "$1" ] ; then
        cd "$1"
    elif [ -f "$1" ] ; then
        cat "$1"
    fi
}

# ls stuff
if ! pgrep 9term >/dev/null && type exa >/dev/null 2>&1 ; then
    alias ls='exa -F'
else
    alias ls='ls -F'
fi

# generic aliases
alias {cc,cll,clear,clar,clea,clera}=clear
alias {x,xx,xxx,q,qq,qqq,:q,:Q,:wq,:w,exi}=exit
alias {l,sls,sl}=ls
alias ll='l -l'
alias la='l -a'
alias lt='command ls -halt'
alias {lla,lal}='l -al'
alias lsf='l "$PWD"/*'
alias {cls,csl,cl,lc}='c;l'
alias {e,ech,eho}=echo
alias {g,gr,gre,Grep,gerp}=grep
alias {pg,pgrep}='pgrep -f'
alias pkill='pkill -f'
alias dg='du | g -i'
alias lg='ls | g -i'
alias cp='cp -irv'
alias mv='mv -iv'
alias {mkdir,mkd,mkdr}='mkdir -p'
alias df='df -h'
alias ag='a | g -i'
alias bn=basename
alias date="command date '+%a %b %d - %I:%M %p'"
alias dmegs=dmesg
alias h='head -n 15'
alias t='tail -n 15'
alias {w,watch}='watch -t -n 1'
alias ex=export
alias cx='chmod +x'
alias poweroff='sudo poweroff'
alias {reboot,restart}='sudo reboot'
alias chroot='sudo chroot'
alias su='su -'

# gnu make
alias {make,mak}="make -j$(( $NPROC + 1 ))"
alias {makec,makc}='make clean'
alias {makei,maki}='make install'
alias {makeu,maku}='make uninstall'
alias {makea,maeka,maka}='makec;make;makei'
alias makeac='makea;c'

# plan9 make
alias mkc='mk clean'
alias mki='mk install'
alias mku='mk uninstall'
alias mka='mkc;mk;mki'

# common program aliases
alias diff='diff -u'
alias {less,les}='less -QRd'
alias view='${EDITOR} -R'
alias rsync='rsync -rtvuh4 --progress --delete' #-c
alias sshd='sudo /usr/sbin/sshd'
alias scp='scp -rp4'
alias {htpo,hto,ht,hpot,hotp,top}='htop'
alias {hm,hme}='htop -u ${USER}'
alias {hr,hroot}='htop -u root'
alias nf=neofetch
alias rtv='rtv --enable-media ; c'
alias compton='pkill compton ; compton & c'
alias feh='feh -q -N -x -X -s -Z --scale-down --title feh'
alias click='xdotool click 1'

# weather
alias weather='curl -s wttr.in/madison,sd?m0TQ'
alias forecast='curl -s http://wttr.in/madison,sd?m | \
   tail -n 33 | sed $\ d | sed $\ d'

# random printing
alias heart='printf "%b\n" "\xe2\x9d\xa4"'

# hash stuff
md5=md5sum
sha1=sha1sum
sha256=sha256sum
sha512=sha512sum

ps() {
    if [ $# -gt 0 ] ; then
        command ps auwwx | g -i "$@" | g -v grep
    else
        command ps auwwx
    fi | head -n 20
}

mkcd() { mkd "$_" && cd "$_" ; }
mvcd() { mv "$1" "$2" && cd "$2" ; }
cpcd() { cp "$1" "$2" && cd "$2" ; }

du() { 
    [ $# -eq 0 ] && set .
    command du -ahLd 1 "$1" | sort -rh | head -n 20
} 2> /dev/null

# files
f() { 
    case $# in
        1) set . "$@" ;;
        0) read inp && set . "$inp"
    esac

    find "$1" ! -path "$1" -iname "*$2*" ; 
}

unalias r
r() { ranger "$@" ; c ; }

# Hack!
echossh() {
    if [ $# -lt 3 ] ; then
        >&2 echo 'usage: echossh user@host file $@'
        return 1
    else
        local user_at_host="$1"
        local file="$2"
        shift 2
        echo "$@" | ssh "$user_at_host" \
            sh -c "cat /dev/stdin >> $file"
    fi
}

# if ps1 gets bugged out
ps1() { export PS1='% ' ; }

# search history for command: "history grep", no its not mercurial.
hg() { [ "$1" ] && grep -e "$*" $HISTFILE | grep -v '^hg' | head -n 20 ; }

ext() { e "${1##*.}" ; }
filename() { e "${1%.*}" ; }
cheat() { curl -s cheat.sh/$1 ; }
rgb2hex() { printf "#%02x%02x%02x\n" "$@" ; }

reload() {
    . ~/etc/aliases
    . ~/etc/fff.conf
    xrdb load ~/etc/Xresources
    xmodmap ~/etc/Xmodmap
    xset m 0 0 
    xset b off 
    xset +fp /home/mitch/.fonts
    xset fp rehash
    fc-cache
} > /dev/null 2>&1

ping() {
    if [ $# -eq 0 ] ; then
        online && echo Online!
    else
        /bin/ping "$@"
    fi
}

w3m() {
    [ $# -eq 0 ] && set https://ddg.gg/lite
    command w3m -F "$@"
}

v() { 
    # if no arguments, open my vimwiki page
    if [ $# -eq 0 ] ; then
        if [ -d ${HOME}/var/files/vimwiki ] && [ $EDITOR = nvim ] ; then
            set -- -c VimwikiIndex
        fi
        $EDITOR "$@"
        return
    fi

    # fuzzy-find file / recurse down
    if [ -f "$1" ] ; then
        $EDITOR "$1"
    else
        for i in 1 2 3 4 5 ; do
            local f="$(find . -iname *"$@"* -maxdepth $i | head -n 1)"
            if [ -f "$f" ] ; then
                $EDITOR "$f"
                return
            fi
        done
        $EDITOR "$@"
    fi 2> /dev/null
}
alias {V,vim}=v

mpv() { 
    [ $# -eq 0 ] && return 1

    # kill any currently running mpv before launching a new
    if pgrep xwinwrap > /dev/null ; then
        # kill all mpv except the one with the mpvbg pid
        # as not to kill our desktop background! see ~/bin/mpv/mpvbg for details
        kill $(pgrep -a mpv | grep -v mpvbg | awk '{print $1}')
    else
        pkill mpv
    fi > /dev/null 2>&1

    command mpv --title=mpv "$@"
}
mpvm() { mpv --no-video "$@" ; }

# youtube-dl
ytdlm() { 
    for i ; do
        youtube-dl --geo-bypass --prefer-ffmpeg --extract-audio \
            --audio-quality 0 --audio-format opus "$i"
    done
}
ytdl() { 
    for i ; do
        youtube-dl --geo-bypass --prefer-ffmpeg "$i"
    done
}

# imagemagick
resize_75() { mogrify -resize '75%X75%' "$@" ; }
resize_50() { mogrify -resize '50%X50%' "$@" ; }
resize_25() { mogrify -resize '25%X25%' "$@" ; }

# translate-shell
trans() {
    [ $# -eq 0 ] && read inp && set "$inp"
    command trans -no-auto -b "$@"
}
rtrans() {
    [ $# -eq 0 ] && read inp && set "$inp"
    # note: $1 needs to be language code, ex: 'de'
    command trans -from en -to "$@"
}
rde() {
    [ $# -eq 0 ] && read inp && set "$inp"
    rtrans de "$*"
}

# ----------------- movement commands -----------------------
alias {..,cd..}='cd ..'
alias ...='.. ; ..'
alias ....='.. ; ...'

# directory marking
# usage: 'm1' = mark 1
#        'g1' = return to m1
for i in 1 2 3 4 5 6 7 8 9 ; do
    eval "m${i}() { export _MARK${i}=\$PWD ; }"
    eval "g${i}() { cd \$_MARK${i} ; }"
done

_g() { local a=$1 ; shift ; cd $a/"$@" ; cl ;  }

for i in bin env etc tmp usr var src ; do
    alias g$(printf %.1s $i)="_g ~/$i"
    alias g$(printf %.1s $i | tr '[a-z]' '[A-Z]')="_g /$i"
done

alias gM='_g /mnt'

mT() { mv "$@" /tmp  ; }
YT() { cp "$@" /tmp  ; }

if [ -d ~/var ] ; then
    for i in downloads files images music ; do
        alias g$(printf %.1s $i)="_g ~/var/$i"
    done

    alias {gvi,gvid}='_g ~/var/videos'
    alias gbk='_g ~/var/books'
    alias gvt='_g ~/var/tmp'
    alias gyt='_g ~/.youtube-dl'

    Yf() { cp "$@" ~/var/files     ; }
    Yd() { cp "$@" ~/var/downloads ; }
    Yi() { cp "$@" ~/var/images    ; }
    Ym() { cp "$@" ~/var/music     ; }
    Yvi(){ cp "$@" ~/var/videos    ; }

    mf() { mv "$@" ~/var/files     ; }
    md() { mv "$@" ~/var/downloads ; }
    mi() { mv "$@" ~/var/images    ; }
    mm() { mv "$@" ~/var/music     ; }
    mvi(){ mv "$@" ~/var/videos    ; }
fi

if [ -d ~/usr ] ; then
    alias gr='_g ~/usr/repos' 
    alias gbkup='_g ~/usr/backup'
    mu() { mv "$@" ~/usr ; }
    mr() { mv "$@" ~/usr/repos ; }
    Yu() { cp "$@" ~/usr ; }
    Yr() { cp "$@" ~/usr/repos ; }
fi

if [ -d ~/etc ] ; then
    me() { mv "$@" ~/etc ; }
    Ye() { cp "$@" ~/etc ; }
    alias gcf='_g ~/etc/config'

    alias {aliases,alaises,aliase}='v ~/etc/aliases'
    alias profile='v ~/etc/profile'
    alias {bkm,bmk}='r ~/var/files/bkm'
    alias {vssh,sshv}='v ~/.ssh/config'

    alias vimrc="v ~/etc/vimrc"
    alias kshrc="v ~/etc/kshrc"
fi

if [ -d ~/src ] ; then
    alias gs='_g ~/src'
    ms() { mv "$@" ~/src ; }
    Ys() { cp "$@" ~/src ; }
fi

if [ -d ~/bin ] ; then
    mb() { mv "$@" ~/bin ; }
    Yb() { cp "$@" ~/bin ; }
fi

if [ -d ~/tmp ] ; then
    mt() { mv "$@" ~/tmp ; }
    Yt() { cp "$@" ~/tmp ; }
fi

if [ -d ~/env ] ; then
    mn() { mv "$@" ~/env ; }
    Yn() { cp "$@" ~/env ; }
    alias gn='_g ~/env'
fi

m_() { mv "$@" ~/.trash ; }
Y_() { cp "$@" ~/.trash ; }
alias g_='_g ~/.trash'
alias trash=m_

# ----------- end movement commands ------------------

alias save_unsplash_wall="cp ${HOME}/var/tmp/wall ${HOME}/var/images/wallpapers/unsplash/saved_\"$(date)\".png"
save_wall() { cp -f "$1" ${HOME}/var/tmp/wall ; }

# skeletons
helloc() {
cat > hello.c << EOF
#include <stdio.h>
int main() { printf("%s\n", "hi"); return 0; }
EOF
}
hellosh() {
cat > hello.sh << EOF
#!/bin/sh
main() { printf "%s\n" "hi" ; }
main "$@"
EOF
chmod +x hello.sh
}

gud() {
    # activate my PS1 git branch detection after
    # git commands
    command gud "$@" ; cd .
}

alias {repomc,reocmp,reomcp,recopm,recmop,recpom}=recomp

forgrep() {
    find . -type f | while read -r file ; do
        grep "$*" "$file" >/dev/null && echo $file
    done
}

# -*-*- bonsai stuff *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
alias bonsai="cd ~/src/bonsai ; ./bonsai"
alias {b,bs,bpm}=bonsai
alias chroot.sh=~/src/bonsai-tools/chroot.sh
alias pkgskel=~/src/bonsai-tools/pkgskel
export root=~/env/bs1
# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
